(window.webpackJsonp=window.webpackJsonp||[]).push([[64],{578:function(n,s,a){"use strict";a.r(s);var t=a(4),e=Object(t.a)({},(function(){var n=this,s=n.$createElement,a=n._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":n.$parent.slotKey}},[a("p",[n._v("这篇日志记录在"),a("code",[n._v("docker")]),n._v("环境下使用"),a("code",[n._v("Nginx")]),n._v("进行"),a("strong",[n._v("静态网站部署")]),n._v("和"),a("strong",[n._v("负载均衡")]),n._v("配置")]),n._v(" "),a("h2",{attrs:{id:"静态网站部署"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#静态网站部署"}},[n._v("#")]),n._v(" 静态网站部署")]),n._v(" "),a("p",[n._v("根据网上查找资料，小型静态网站部署在"),a("code",[n._v("Nginx")]),n._v("上能够具有更高的性能。以我的Blog使用"),a("code",[n._v("docker-compose")]),n._v("方式来部署在"),a("code",[n._v("nginx")]),n._v("为例:")]),n._v(" "),a("ol",[a("li",[a("p",[n._v("目录结构：")]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v(".\n├─ docker-compose.yml\n├─ nginx.conf\n└─ public (build好的静态网站)\n    ├─ index.html\n    └─ ...\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br")])])]),n._v(" "),a("li",[a("p",[a("code",[n._v("docker-compose.yml")]),n._v("文件为：")]),n._v(" "),a("div",{staticClass:"language-yml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[n._v('"2"')]),n._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("services")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("blog_nginx")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v(" nginx\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("container_name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v(" blog_nginx\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("-")]),n._v(" 8123"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[n._v("80")]),n._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("volumes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("-")]),n._v(" /home/ubuntu/neilwan.gitlab.io/public/"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("/data/www/\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("-")]),n._v(" /home/ubuntu/neilwan.gitlab.io/nginx.conf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("/etc/nginx/nginx.conf\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br")])]),a("ul",[a("li",[n._v("我们指定将静态网站文件目录挂载到"),a("code",[n._v("/data/www")]),n._v("下")]),n._v(" "),a("li",[n._v("开启8123端口")])])]),n._v(" "),a("li",[a("p",[a("code",[n._v("nginx.conf")]),n._v("文件为：")]),n._v(" "),a("div",{staticClass:"language-conf line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("div",{staticClass:"highlighted"},[n._v(" ")]),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br")]),a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("http {\n    ....\n    server {\n        listen       80 default_server;\n        listen       [::]:80 default_server;\n        server_name  _;\n        root         /data/www;\n\n        include /etc/nginx/default.d/*.conf;\n\n        location / {\n        }\n\n        error_page 404 /404.html;\n            location = /40x.html {\n        }\n\n        error_page 500 502 503 504 /50x.html;\n            location = /50x.html {\n        }\n    }\n}\n")])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br"),a("span",{staticClass:"line-number"},[n._v("21")]),a("br"),a("span",{staticClass:"line-number"},[n._v("22")]),a("br")])])]),n._v(" "),a("li",[a("p",[n._v("启动"),a("code",[n._v("docker-compose")]),n._v("，访问8123端口成功")]),n._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[n._v("docker-compose up\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br")])])])]),n._v(" "),a("h2",{attrs:{id:"负载均衡"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#负载均衡"}},[n._v("#")]),n._v(" 负载均衡")]),n._v(" "),a("p",[n._v("当使用多个instance来分摊服务器压力时，需要使用"),a("code",[n._v("Nginx")]),n._v("来对多个服务器进行负载均衡。")]),n._v(" "),a("p",[n._v("项目结构与部署静态网站相同。")]),n._v(" "),a("ol",[a("li",[a("p",[a("code",[n._v("docker-compose.yml")]),n._v("文件中启动2个instance，分别启动在8123和8124端口上:")]),n._v(" "),a("div",{staticClass:"language-yml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[n._v('"2"')]),n._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("services")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("blog_nginx1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v(" nginx\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("container_name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v(" blog_nginx1\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("-")]),n._v(" 8123"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[n._v("80")]),n._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("volumes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("-")]),n._v(" /home/ubuntu/neilwan.gitlab.io/public/"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("/data/www/\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("-")]),n._v(" /home/ubuntu/neilwan.gitlab.io/nginx.conf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("/etc/nginx/nginx.conf\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("blog_nginx2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v(" nginx\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("container_name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v(" blog_nginx2\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("-")]),n._v(" 8124"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[n._v("80")]),n._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("volumes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("-")]),n._v(" /home/ubuntu/neilwan.gitlab.io/public/"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("/data/www/\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("-")]),n._v(" /home/ubuntu/neilwan.gitlab.io/nginx.conf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("/etc/nginx/nginx.conf\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br")])])]),n._v(" "),a("li",[a("p",[n._v("部署静态网站的"),a("code",[n._v("Nginx")]),n._v("与部署静态网站相同。")])]),n._v(" "),a("li",[a("p",[n._v("网关"),a("code",[n._v("Nginx")]),n._v("的配置。"),a("strong",[n._v("注意：这里的"),a("code",[n._v("Nginx")]),n._v("不是部署静态网站的"),a("code",[n._v("Nginx")]),n._v("，而是另外一个专门给用于负载均衡的网关"),a("code",[n._v("Nginx")])])]),n._v(" "),a("ol",[a("li",[a("p",[a("strong",[n._v("轮询")]),n._v("（Instance无差别对待）")]),n._v(" "),a("div",{staticClass:"language-conf line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("br"),a("br"),a("div",{staticClass:"highlighted"},[n._v(" ")]),a("div",{staticClass:"highlighted"},[n._v(" ")]),a("div",{staticClass:"highlighted"},[n._v(" ")]),a("div",{staticClass:"highlighted"},[n._v(" ")]),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("div",{staticClass:"highlighted"},[n._v(" ")]),a("div",{staticClass:"highlighted"},[n._v(" ")]),a("div",{staticClass:"highlighted"},[n._v(" ")]),a("br"),a("br"),a("br")]),a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('http {\n  ....\n upstream blog-balance {\n     server www.616team.com:8123;\n     server www.616team.com:8124;\n  }\n  server {\n    listen 80;\n    server_name *.616team.com;\n    client_max_body_size 10m;\n\n    if ($http_host ~* "^(.*?)\\.616team\\.com$") {\n      set $domain $1;\n    }\n    location / {\n      if ($domain ~* "blog-balance") {\n        proxy_pass http://blog-balance;\n      }\n    }\n}\n')])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br")])]),a("p",[n._v("多次访问"),a("a",{attrs:{href:"http://blog-balance.616team.com",target:"_blank",rel:"noopener noreferrer"}},[n._v("http://blog-balance.616team.com"),a("OutboundLink")],1),n._v("，可以看到两个instance交替收到请求")]),n._v(" "),a("p",[a("img",{attrs:{src:"https://img-1252535357.cos.ap-chengdu.myqcloud.com/blog/nginx_balance1.png",alt:"Nginx轮询"}})])]),n._v(" "),a("li",[a("p",[a("strong",[n._v("权重")]),n._v("（根据不同机器的性能设计不同的权重）")]),n._v(" "),a("div",{staticClass:"language-conf line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("br"),a("br"),a("br"),a("div",{staticClass:"highlighted"},[n._v(" ")]),a("div",{staticClass:"highlighted"},[n._v(" ")]),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br")]),a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('http {\n  ....\n  upstream blog-balance {\n        server www.616team.com:8123 weight=2;\n        server www.616team.com:8124 weight=1;\n  }\n  server {\n    listen 80;\n    server_name *.616team.com;\n    client_max_body_size 10m;\n\n    if ($http_host ~* "^(.*?)\\.616team\\.com$") {\n      set $domain $1;\n    }\n    location / {\n      if ($domain ~* "blog-balance") {\n        proxy_pass http://blog-balance;\n      }\n    }\n}\n')])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br")])]),a("p",[n._v("多次访问"),a("a",{attrs:{href:"http://blog-balance.616team.com",target:"_blank",rel:"noopener noreferrer"}},[n._v("http://blog-balance.616team.com"),a("OutboundLink")],1),n._v("，可以看到"),a("code",[n._v("blog_nginx1")]),n._v("收到的请求数是"),a("code",[n._v("blog_nginx2")]),n._v("的2倍")]),n._v(" "),a("p",[a("img",{attrs:{src:"https://img-1252535357.cos.ap-chengdu.myqcloud.com/blog/nginx_balance_weight1.png",alt:"Nginx加权"}})])]),n._v(" "),a("li",[a("p",[a("strong",[n._v("失败次数")]),n._v("（当某台机器失效之后新请求不会分配至这台机器，且可以启用备份机器）")]),n._v(" "),a("p",[n._v("a. 再加一台instance")]),n._v(" "),a("div",{staticClass:"language-yml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[n._v('"2"')]),n._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("services")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("blog_nginx1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v(" nginx\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("container_name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v(" blog_nginx1\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("-")]),n._v(" 8123"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[n._v("80")]),n._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("volumes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("-")]),n._v(" /home/ubuntu/neilwan.gitlab.io/public/"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("/data/www/\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("-")]),n._v(" /home/ubuntu/neilwan.gitlab.io/nginx.conf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("/etc/nginx/nginx.conf\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("blog_nginx2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v(" nginx\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("container_name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v(" blog_nginx2\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("-")]),n._v(" 8124"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[n._v("80")]),n._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("volumes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("-")]),n._v(" /home/ubuntu/neilwan.gitlab.io/public/"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("/data/www/\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("-")]),n._v(" /home/ubuntu/neilwan.gitlab.io/nginx.conf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("/etc/nginx/nginx.conf\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("blog_nginx3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v(" nginx\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("container_name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v(" blog_nginx3\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("-")]),n._v(" 8125"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[n._v("80")]),n._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[n._v("volumes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("-")]),n._v(" /home/ubuntu/neilwan.gitlab.io/public/"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("/data/www/\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v("-")]),n._v(" /home/ubuntu/neilwan.gitlab.io/nginx.conf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[n._v(":")]),n._v("/etc/nginx/nginx.conf\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br"),a("span",{staticClass:"line-number"},[n._v("21")]),a("br"),a("span",{staticClass:"line-number"},[n._v("22")]),a("br"),a("span",{staticClass:"line-number"},[n._v("23")]),a("br"),a("span",{staticClass:"line-number"},[n._v("24")]),a("br"),a("span",{staticClass:"line-number"},[n._v("25")]),a("br"),a("span",{staticClass:"line-number"},[n._v("26")]),a("br")])]),a("p",[n._v("b. 配置网关")]),n._v(" "),a("div",{staticClass:"language-conf line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("br"),a("br"),a("br"),a("div",{staticClass:"highlighted"},[n._v(" ")]),a("div",{staticClass:"highlighted"},[n._v(" ")]),a("div",{staticClass:"highlighted"},[n._v(" ")]),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br")]),a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('http {\n  ....\n  upstream blog-balance {\n        server www.616team.com:8123 weight=2 max_fails=3 fail_timeout=15;\n        server www.616team.com:8124 weight=1;\n        server www.616team.com:8125 weight=1 backup;\n  }\n  server {\n    listen 80;\n    server_name *.616team.com;\n    client_max_body_size 10m;\n\n    if ($http_host ~* "^(.*?)\\.616team\\.com$") {\n      set $domain $1;\n    }\n    location / {\n      if ($domain ~* "blog-balance") {\n        proxy_pass http://blog-balance;\n      }\n    }\n}\n')])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br"),a("span",{staticClass:"line-number"},[n._v("21")]),a("br")])]),a("p",[n._v("其中：")]),n._v(" "),a("ul",[a("li",[n._v("当"),a("code",[n._v("blog_nginx1")]),n._v("达到max_fails(3)次失败请求后，在fail_timeout(15s)期间内，nginx会认为这台"),a("code",[n._v("blog_nginx1")]),n._v("暂时不可用，不会将请求分配给它")]),n._v(" "),a("li",[n._v("当所有非备用机（"),a("code",[n._v("blog_nginx1")]),n._v("和"),a("code",[n._v("blog_nginx2")]),n._v("）都不可用时，才会启用备用机（"),a("code",[n._v("blog_nginx3")]),n._v("）")])]),n._v(" "),a("p",[n._v("下面来测试一下：")]),n._v(" "),a("ul",[a("li",[a("p",[n._v("启动3个instance和nginx，并多次访问"),a("a",{attrs:{href:"http://blog-balance.616team.com",target:"_blank",rel:"noopener noreferrer"}},[n._v("http://blog-balance.616team.com"),a("OutboundLink")],1),n._v("，可以看到"),a("code",[n._v("blog_nginx1")]),n._v("和"),a("code",[n._v("blog_nginx2")]),n._v("以2:1的比例接收到请求，"),a("code",[n._v("blog_nginx3")]),n._v("不会接收到请求，因为非备用机 可用")]),n._v(" "),a("p",[a("img",{attrs:{src:"https://img-1252535357.cos.ap-chengdu.myqcloud.com/blog/nginx_balance_backup1.png",alt:"Nginx"}})])]),n._v(" "),a("li",[a("p",[n._v("停止"),a("code",[n._v("blog_nginx1")]),n._v("，发现请求全部转发到"),a("code",[n._v("blog_nginx2")]),n._v("，"),a("code",[n._v("blog_nginx3")]),n._v("依然没有启用，因为不是所有非备用机都不可用")]),n._v(" "),a("p",[a("img",{attrs:{src:"https://img-1252535357.cos.ap-chengdu.myqcloud.com/blog/nginx_balance_fail1.png",alt:"Nginx"}})])]),n._v(" "),a("li",[a("p",[n._v("停止"),a("code",[n._v("blog_nginx1")]),n._v("和"),a("code",[n._v("blog_nginx2")]),n._v("，发现"),a("code",[n._v("blog_nginx3")]),n._v("启用，请求全部转发到"),a("code",[n._v("blog_nginx3")])]),n._v(" "),a("p",[a("img",{attrs:{src:"https://img-1252535357.cos.ap-chengdu.myqcloud.com/blog/nginx_balance_backup2.png",alt:"Nginx"}})])]),n._v(" "),a("li",[a("p",[n._v("重启"),a("code",[n._v("blog_nginx1")]),n._v("和"),a("code",[n._v("blog_nginx2")]),n._v("，发现"),a("code",[n._v("blog_nginx1")]),n._v("和"),a("code",[n._v("blog_nginx2")]),n._v("继续以2:1的比例接收请求，同时"),a("code",[n._v("blog_nginx3")]),n._v("停用")]),n._v(" "),a("p",[a("img",{attrs:{src:"https://img-1252535357.cos.ap-chengdu.myqcloud.com/blog/nginx_balance_backup3.png",alt:"Nginx"}})])])])])])])]),n._v(" "),a("br"),n._v(" "),a("hr"),n._v(" "),a("br"),n._v(" "),a("Vssue",{attrs:{title:n.$title}})],1)}),[],!1,null,null,null);s.default=e.exports}}]);