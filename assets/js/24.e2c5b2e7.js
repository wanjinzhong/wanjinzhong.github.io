(window.webpackJsonp=window.webpackJsonp||[]).push([[24],{536:function(s,t,a){"use strict";a.r(t);var n=a(4),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("p",[s._v("目前我的博客源文件管理在Github上，提交后触发搭建在我的服务器上的Jenkins, Jenkins进行build。并将build成功的docker镜像发布到docker hub，再部署到我的服务器上。")]),s._v(" "),a("p",[s._v("这样会使用到以下平台：")]),s._v(" "),a("ul",[a("li",[s._v("Github")]),s._v(" "),a("li",[s._v("我的服务器")])]),s._v(" "),a("p",[s._v("考虑到我的服务器1年之后将到期，而我没有想法再去续约，加之最近我的服务器上的Jenkins访问Github变得极其困难。所以考虑迁移平台：不依赖我的服务器并且淘汰Github。")]),s._v(" "),a("p",[s._v("最近发现新大陆：Gitlab访问速度比Github快非常多，并且自带CI/CD，每月提供400分钟免费的构建时间，所以计划使用Gitlab代替Github")]),s._v(" "),a("p",[s._v("具体方法是：将博客源文件管理在Gitlab上，提交后自动触发Gitlab的CI/CD，将构建好的静态站点文件部署在Gitlab pages里（同样也会部署到Github pages作为备用站点），将构建出的Docker镜像发布至Docker Hub中（在服务器过期之前，依然会使用服务器运行Docker镜像来提高博客的访问速度）。")]),s._v(" "),a("p",[s._v("其重点是"),a("code",[s._v(".gitlab-ci.yml")]),s._v("文件，这里记录几个"),a("code",[s._v(".gitlab-ci.yml")]),s._v("文件的编写技巧：")]),s._v(" "),a("ol",[a("li",[a("p",[s._v("对"),a("code",[s._v("node_modules")]),s._v("目录使用缓存，这样在下一次"),a("code",[s._v("npm install")]),s._v("的时候就不会再重新下载npm依赖包了，可以节约一些构建时间：")]),s._v(" "),a("div",{staticClass:"language-yml line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("br"),a("br"),a("br"),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br")]),a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("stages")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" npm_build\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cache")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("key")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" $"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("CI_BUILD_REF_NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("paths")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" node_modules/\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("npm_build")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("stage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" npm_build\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" node"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("latest\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" \n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" npm install\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" npm run build\n\n")])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("使用"),a("code",[s._v("artifacts")]),s._v("来将这个管道构建的结果传递到下一个管道：")]),s._v(" "),a("div",{staticClass:"language-yml line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br")]),a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("npm_build")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("stage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" npm_build\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" node"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("latest\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" \n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" npm install\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" npm run build\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("artifacts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("paths")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" blog"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("dist/\n")])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("使用docker镜像进行构建的时候一定要加上"),a("code",[s._v("services")])]),s._v(" "),a("div",{staticClass:"language-yml line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("br"),a("br"),a("br"),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("br")]),a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("docker_build")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("stage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" docker\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" docker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("stable\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("services")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" docker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("dind\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("before_script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" docker login "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("u $MY_DOCKER_USERNAME "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("p $MY_DOCKER_PASSWORD $DOCKER_HUB_REGISTRY\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" \n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" docker build "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("t $DOCKER_HUB_REGISTRY/wanjinzhong/neilwan"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("blog"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("latest .\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" docker push $DOCKER_HUB_REGISTRY/wanjinzhong/neilwan"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("blog"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("latest\n\n")])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("如果要使用带密码的"),a("code",[s._v("ssh")]),s._v("和"),a("code",[s._v("scp")]),s._v("，需要安装"),a("code",[s._v("sshpass")]),s._v("，并且在执行命令的时候加上"),a("code",[s._v("-oStrictHostKeyChecking=no")]),s._v("参数")]),s._v(" "),a("div",{staticClass:"language-yml line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("br"),a("br"),a("br"),a("br"),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br")]),a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("deploy_to_myserver")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("stage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" deploy\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" alpine"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("latest\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" \n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" apk update\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" apk add openssh sshpass\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" sshpass "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("p $MY_SERVER_616TEAM_PASSWORD scp "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("oStrictHostKeyChecking=no docker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("compose.yml $MY_SERVER_616TEAM_USERNAME@$MY_SERVER_616TEAM_SERVER"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/docker/blog/docker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("compose.yml\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" sshpass "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("p $MY_SERVER_616TEAM_PASSWORD ssh "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("oStrictHostKeyChecking=no $MY_SERVER_616TEAM_USERNAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v('$MY_SERVER_616TEAM_PASSWORD@$MY_SERVER_616TEAM_SERVER "cd /docker/blog/ '),a("span",{pre:!0,attrs:{class:"token important"}},[s._v("&&")]),s._v(" docker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("compose pull "),a("span",{pre:!0,attrs:{class:"token important"}},[s._v("&&")]),s._v(" docker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("compose down "),a("span",{pre:!0,attrs:{class:"token important"}},[s._v("&&")]),s._v(" docker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("compose up "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v('d"\n')])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])])])]),s._v(" "),a("br"),s._v(" "),a("hr"),s._v(" "),a("br"),s._v(" "),a("Vssue",{attrs:{title:s.$title}})],1)}),[],!1,null,null,null);t.default=e.exports}}]);